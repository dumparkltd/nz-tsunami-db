define(["jquery","underscore","backbone","bootstrap","./map/MapView","./map/MapModel","./table/TableView","./table/TableModel","text!./out.html","text!./out_nav.html","text!./out_data.html","text!./out_navInfo.html","text!./out_navReset.html"],function(e,t,o,s,i,l,a,d,r,u,h,c,n){return o.View.extend({events:{"click .toggle-view":"toggleView","click .toggle-data":"toggleData","click .close-data":"closeData","click .out-nav-reset-records .query-reset":"queryReset","click .out-nav-reset-sources .query-reset":"queryResetSources","click .download-data":"downloadData"},initialize:function(){this.views=this.model.getViews(),this.render(),this.listenTo(this.model,"change:active",this.handleActive),this.listenTo(this.model,"change:mapView",this.updateMapViewMain),this.listenTo(this.model,"change:outType",this.updateOutType),this.listenTo(this.model,"change:outMapType",this.updateOutMapType),this.listenTo(this.model,"change:outMapShowRecords",this.updateOutShowRecords),this.listenTo(this.model,"change:outMapShowSources",this.updateOutShowSources),this.listenTo(this.model,"change:outColorColumn",this.updateOutColorColumn),this.listenTo(this.model,"change:outSourceColorColumn",this.updateOutSourceColorColumn),this.listenTo(this.model,"change:outPlotColumns",this.updateOutPlotColumns),this.listenTo(this.model,"change:tableSortColumn",this.updateTableSortColumn),this.listenTo(this.model,"change:tableSortOrder",this.updateTableSortOrder),this.listenTo(this.model,"change:tableSourceSortColumn",this.updateTableSourceSortColumn),this.listenTo(this.model,"change:tableSourceSortOrder",this.updateTableSourceSortOrder),this.listenTo(this.model,"change:recordsUpdated",this.updateRecords),this.listenTo(this.model,"change:sourcesUpdated",this.updateRecords),this.listenTo(this.model,"change:recordId",this.updateSelectedRecord),this.listenTo(this.model,"change:sourceId",this.updateSelectedSource),this.listenTo(this.model,"change:recordMouseOverId",this.updateMouseOverRecord),this.listenTo(this.model,"change:recordsPopup",this.recordsPopup),this.listenTo(this.model,"change:queryLength",this.updateQueryLength),this.listenTo(this.model,"change:querySourcesLength",this.updateQueryLength),this.listenTo(this.model,"change:geoQuery",this.updateGeoQuery),this.listenTo(this.model,"change:geoQuerySources",this.updateGeoQuerySources),this.listenTo(this.model,"change:query",this.updateQuery),this.listenTo(this.model,"change:dataToggled",this.renderData)},render:function(){return this.$el.html(t.template(r)({t:this.model.getLabels()})),this.renderHeader(),this.renderHeaderInfo(),this.renderHeaderReset(),this.updateHeaderActive(),this.updateViews(),this},updateViews:function(){switch(this.initMapView(),this.model.getOutType()){case"map":this.views.table&&this.views.table.model.setActive(!1),this.views.tableSources&&this.views.tableSources.model.setActive(!1),this.views.map.model.setActive(),this.updateMapView();break;case"table":this.initTableView(),this.views.map&&this.views.map.model.setActive(!1),this.views.tableSources&&this.views.tableSources.model.setActive(!1),this.views.table.model.setActive(),this.updateTableView();break;case"source-table":this.initSourceTableView(),this.views.map&&this.views.map.model.setActive(!1),this.views.table&&this.views.table.model.setActive(!1),this.views.tableSources.model.setActive(),this.updateSourceTableView()}},renderHeader:function(){this.$("nav").html(t.template(u)({t:this.model.getLabels()}))},renderHeaderInfo:function(){var e=this.model.getRecords().byActive(),o=this.model.getSources().byActive();this.$("nav .out-nav-info").html(t.template(c)({t:this.model.getLabels(),record_no:void 0!==e?e.length:0,source_no:void 0!==o?o.length:0}))},renderHeaderReset:function(){this.model.get("queryLength")>0?this.$("nav .out-nav-reset-records").html(t.template(n)({t:this.model.getLabels(),type:"r",count:this.model.get("queryLength")})):this.$("nav .out-nav-reset-records").html(""),this.model.get("querySourcesLength")>0?this.$("nav .out-nav-reset-sources").html(t.template(n)({t:this.model.getLabels(),type:"s",count:this.model.get("querySourcesLength")})):this.$("nav .out-nav-reset-sources").html("")},updateHeaderActive:function(e){e=void 0!==e?e:this.model.getOutType(),this.$("nav .toggle-btn").removeClass("active"),this.$("nav .toggle-"+e).addClass("active")},updateRecords:function(){this.renderHeaderInfo(),this.updateViews(),this.renderData()},updateOutType:function(){this.updateHeaderActive(),this.updateViews()},updateQueryLength:function(){this.renderHeaderReset()},canDownload:function(){return(-1==navigator.userAgent.indexOf("Safari")||-1!=navigator.userAgent.indexOf("Chrome"))&&Modernizr.blobconstructor},renderData:function(){if(this.model.get("dataToggled")){var o=this.model.getRecords().byActive(),s=this.model.getSources().byActive();this.$("#data-view").html(t.template(h)({t:this.model.getLabels(),canDownload:this.canDownload(),download:{formats:[{id:"download-csv",title:this.model.getLabels().out.data.formats.csv,format:"csv"}],tables:[{id:"records",title:this.model.getLabels().out.data.tables.records,filterable:!0,no_total:this.model.getRecords()?this.model.getRecords().length:0,no_filtered:void 0!==o?o.length:0,filtered:this.model.get("queryLength")>0},{id:"sources",title:this.model.getLabels().out.data.tables.sources,filterable:!0,no_total:this.model.getSources()?this.model.getSources().length:0,no_filtered:void 0!==s?s.length:0,filtered:this.model.get("querySourcesLength")>0},{id:"references",title:this.model.getLabels().out.data.tables.references,filterable:!1}]}})),this.$("#data-view .nav-tabs a").click(function(t){t.preventDefault(),e(this).tab("show")}),this.$("#data-view .select-on-click").on("click",this.selectOnClick)}else this.$("#data-view").html("")},initTableView:function(){this.$("#table").length>0&&(this.views.table=this.views.table||new a({el:this.$("#table"),model:new d({labels:this.model.getLabels(),columnCollection:this.model.get("columnCollection").byAttribute("table"),columnGroupCollection:this.model.get("columnGroupCollection"),tableSortColumn:void 0!==this.model.get("tableSortColumn")?this.model.get("tableSortColumn"):"id",tableSortOrder:void 0!==this.model.get("tableSortOrder")?this.model.get("tableSortOrder"):"1",active:!0,recordId:"",type:"records"})}))},initSourceTableView:function(){this.$("#tableSources").length>0&&(this.views.tableSources=this.views.tableSources||new a({el:this.$("#tableSources"),model:new d({labels:this.model.getLabels(),columnCollection:this.model.get("sourceColumnCollection").byAttribute("table"),columnGroupCollection:this.model.get("sourceColumnGroupCollection"),tableSortColumn:void 0!==this.model.get("tableSourceSortColumn")?this.model.get("tableSourceSortColumn"):"id",tableSortOrder:void 0!==this.model.get("tableSourceSortOrder")?this.model.get("tableSourceSortOrder"):"1",active:!0,recordId:"",type:"sources"})}))},updateTableView:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&(this.views.table.model.setCurrentRecords(this.model.getRecords().byActive()),this.updateTableSortColumn(),this.updateTableSortOrder())},updateSourceTableView:function(){"source-table"===this.model.getOutType()&&void 0!==this.views.tableSources&&(this.views.tableSources.model.setCurrentRecords(this.model.getSources().byActive()),this.updateTableSourceSortColumn(),this.updateTableSourceSortOrder())},updateTableSortColumn:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("tableSortColumn",void 0!==this.model.get("tableSortColumn")?this.model.get("tableSortColumn"):"id")},updateTableSortOrder:function(){"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("tableSortOrder",void 0!==this.model.get("tableSortOrder")?this.model.get("tableSortOrder"):"1")},updateTableSourceSortColumn:function(){"source-table"===this.model.getOutType()&&void 0!==this.views.tableSources&&this.views.tableSources.model.set("tableSortColumn",void 0!==this.model.get("tableSourceSortColumn")?this.model.get("tableSourceSortColumn"):"id")},updateTableSourceSortOrder:function(){"source-table"===this.model.getOutType()&&void 0!==this.views.tableSources&&this.views.tableSources.model.set("tableSortOrder",void 0!==this.model.get("tableSourceSortOrder")?this.model.get("tableSourceSortOrder"):"1")},initMapView:function(){this.$("#map").length>0&&(this.views.map=this.views.map||new i({el:this.$("#map"),model:new l({labels:this.model.getLabels(),config:this.model.getMapConfig(),layerCollection:this.model.getLayers(),columnCollection:this.model.get("columnCollection"),sourceColumnCollection:this.model.get("sourceColumnCollection"),outShowRecords:this.model.getOutMapShowRecords(),outShowSources:this.model.getOutMapShowSources(),active:!1,popupLayers:[],selectedLayerId:"",recordsUpdated:0})}))},updateMapView:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&(this.updateMapViewMain(),this.updateOutMapType(),this.updateGeoQuery(),this.updateGeoQuerySources(),this.updateOutColorColumn(),this.updateOutSourceColorColumn(),this.updateOutPlotColumns(),this.views.map.model.setCurrentRecords(this.model.getRecords().byActive().hasLocation()),this.views.map.model.setCurrentSources(this.model.getSources().byActive().hasLocation()),this.views.map.model.setRecordsUpdated(this.model.getRecordsUpdated()),this.views.map.model.setSourcesUpdated(this.model.getSourcesUpdated()),this.views.map.model.set("outShowRecords",this.model.getOutMapShowRecords()),this.views.map.model.set("outShowSources",this.model.getOutMapShowSources()))},updateMapViewMain:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&(this.views.map.model.setView(this.model.getActiveMapview()),this.views.map.model.invalidateSize())},updateOutMapType:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outType",this.model.getOutMapType())},updateGeoQuery:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("geoQuery",this.model.get("geoQuery"))},updateGeoQuerySources:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("geoQuerySources",this.model.get("geoQuerySources"))},updateOutShowRecords:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outShowRecords",this.model.getOutMapShowRecords())},updateOutShowSources:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outShowSources",this.model.getOutMapShowSources())},updateOutColorColumn:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outColorColumn",this.model.getOutColorColumn())},updateOutSourceColorColumn:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outSourceColorColumn",this.model.getOutSourceColorColumn())},updateOutPlotColumns:function(){"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("outPlotColumns",this.model.getOutPlotColumns())},recordsPopup:function(){this.views.map.model.set({popupLayers:this.model.get("recordsPopup").length>0?t.map(this.model.get("recordsPopup"),function(e){return{id:e.getLayer().id,layer:e.getLayer().getMapLayerDirect(),color:e.getColor(),label:this.model.getLabels().record.title[e.get("type")]+" "+e.id,selected:e.isSelected(),mouseOver:e.id===this.model.get("recordMouseOverId"),recordType:e.attributes.type}},this):[]})},updateMouseOverRecord:function(){var e=this.model.get("recordMouseOverId");if(""!==e){var t=this.model.getRecords().get(e);t.isActive()&&this.views.map.model.set("mouseOverLayerId",t.getLayer().id)}else this.views.map.model.set("mouseOverLayerId","")},updateSelectedRecord:function(){var e=this.model.get("recordId");if(""!==e){var t=this.model.getRecords().get(e);t.isActive()&&("map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",t.getLayer().id),"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("recordId",e),void 0!==this.views.tableSources&&this.views.tableSources.model.set("recordId",""))}else"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",""),"table"===this.model.getOutType()&&void 0!==this.views.table&&this.views.table.model.set("recordId","")},updateSelectedSource:function(){var e=this.model.get("sourceId");if(""!==e){var t=this.model.getSources().get(e);t.isActive()&&("map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",t.getLayer().id),"source-table"===this.model.getOutType()&&void 0!==this.views.tableSources&&this.views.tableSources.model.set("recordId",e),void 0!==this.views.table&&this.views.table.model.set("recordId",""))}else"map"===this.model.getOutType()&&void 0!==this.views.map&&this.views.map.model.set("selectedLayerId",""),"source-table"===this.model.getOutType()&&void 0!==this.views.tableSources&&this.views.tableSources.model.set("recordId","")},toggleView:function(t){t.preventDefault(),this.model.set("dataToggled",!1),this.$el.trigger("setOutView",{out_view:e(t.currentTarget).attr("data-view")})},handleActive:function(){this.model.isActive()?this.$el.show():this.$el.hide()},queryReset:function(e){e.preventDefault(),this.$el.trigger("recordQuerySubmit",{query:{}})},queryResetSources:function(e){e.preventDefault(),this.$el.trigger("sourceQuerySubmit",{query:{}})},toggleData:function(e){e.preventDefault(),this.model.set("dataToggled",!this.model.get("dataToggled")),this.model.get("dataToggled")?this.updateHeaderActive("data"):this.updateHeaderActive()},closeData:function(e){e.preventDefault(),this.model.set("dataToggled",!1),this.updateHeaderActive()},selectOnClick:function(e){e.preventDefault(),e.target.focus(),e.target.select(),setTimeout(function(){e.target.setSelectionRange(0,9999)},1)},downloadData:function(t){if(t.preventDefault(),this.canDownload()){var o=e(t.currentTarget).attr("data-format"),s=e(t.currentTarget).attr("data-table"),i=e(t.currentTarget).attr("data-active");if("csv"===o){var l,a="",d="";switch(s){case"records":a="true"===i?this.model.get("recordCollection").byActive().toCSV():this.model.get("recordCollection").toCSV(),d="true"===i?"records_filtered.csv":"records.csv";break;case"sources":a="true"===i?this.model.get("sourceCollection").byActive().toCSV():this.model.get("sourceCollection").toCSV(),d="true"===i?"sources_filtered.csv":"sources.csv";break;case"references":a=this.model.get("recordCollection").getReferences().toCSV(),d="references.csv"}var r=new Blob([a],{type:"text/csv;charset=utf-8;"});if(navigator&&navigator.msSaveBlob)navigator.msSaveBlob(r,d);else{var l=document.createElement("a");if(void 0!==l.download){var u=URL.createObjectURL(r);l.setAttribute("href",u),l.setAttribute("download",d),l.setAttribute("target","_blank"),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}}}}}})});