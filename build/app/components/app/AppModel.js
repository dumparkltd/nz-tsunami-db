define(["jquery","underscore","backbone"],function(t,e,r){return r.Model.extend({initialize:function(e){this.options=e||{},this.set("appConfigLoaded",!1),this.set("configsLoaded",!1),this.set("recordsLoaded",!1),this.set("sourcesLoaded",!1),this.set("referencesLoaded",!1),this.set("recordsConfigured",!1),this.set("recordsUpdated",!1),this.set("sourcesConfigured",!1),this.set("sourcesUpdated",!1),this.set("pagesConfigured",!1),this.set("referencesConfigured",!1),this.set("columnsConfigured",!1),this.set("columnsInitialised",!1),this.set("sourceColumnsConfigured",!1),this.set("sourceColumnsInitialised",!1),this.set("mapConfigured",!1),this.set("lastDBRoute",{route:"db",path:""}),this.set("shareToggled",!1);var r=this;t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.configFile,success:function(e){r.setConfig(e),t.ajax({dataType:"json",url:r.attributes.baseurl+r.attributes.config.labels,success:function(t){r.setLabels(t)},error:function(){console.log("error loading terms config")}})},error:function(){console.log("error loading app config")}})},setConfig:function(t){this.set("config",t)},getConfig:function(){return this.attributes.config},setLabels:function(t){this.set("labels",t)},getLabels:function(){return this.attributes.labels},loadConfigs:function(){var e=this;t.when(t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.layersConfig}),t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.mapConfig}),t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.columns}),t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.columnGroups}),t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.sourceColumns}),t.ajax({dataType:"json",url:this.attributes.baseurl+this.attributes.config.sourceColumnGroups})).then(function(t,r,i,o,s,u){e.set("layersConfig",t[0]),e.set("mapConfig",r[0]),e.set("columnConfig",i[0]),e.set("columnGroupConfig",o[0]),e.set("sourceColumnConfig",s[0]),e.set("sourceColumnGroupConfig",u[0]),e.set("configsLoaded",!0)},function(){console.log("error loading configs")})},configsLoaded:function(){return this.attributes.configsLoaded},dataReady:function(){return this.get("recordsLoaded")&&this.get("sourcesLoaded")&&this.get("referencesLoaded")},validateRouter:function(t){t(!0)},getViews:function(){return this.attributes.views},getRouter:function(){return this.attributes.router},getBaseURL:function(){return this.attributes.baseurl},setRoute:function(t){return"db"===t.route&&this.set("lastDBRoute",t),this.set("route",{route:t.route,path:t.path,query:t.query}),this},getRoute:function(){return this.attributes.route.route},getPath:function(){return this.attributes.route.path},getLastDBPath:function(){return this.attributes.lastDBRoute.path},getLastDBRoute:function(){return this.attributes.lastDBRoute},getQuery:function(){return e.clone(this.attributes.route.query)},getRecordQuery:function(){var t={};return e.each(this.getQuery(),function(e,r){r.startsWith("q_")&&(t[r.replace("q_","")]=e)}),t},getSourceQuery:function(){var t={};return e.each(this.getQuery(),function(e,r){r.startsWith("qs_")&&(t[r.replace("qs_","")]=e)}),t},getGeoQuery:function(){var t=this.attributes.columnCollection.get("lat"),e=this.attributes.columnCollection.get("lng"),r=this.getRecordQuery();return{north:r[t.getQueryColumnByType("max")],south:r[t.getQueryColumnByType("min")],east:r[e.getQueryColumnByType("max")],west:r[e.getQueryColumnByType("min")]}},getGeoQuerySources:function(){var t=this.attributes.sourceColumnCollection.get("lat"),e=this.attributes.sourceColumnCollection.get("lng"),r=this.getSourceQuery();return{north:r[t.getQueryColumnByType("max")],south:r[t.getQueryColumnByType("min")],east:r[e.getQueryColumnByType("max")],west:r[e.getQueryColumnByType("min")]}},getOutType:function(){return this.attributes.route.query.out},getFilterType:function(){return this.attributes.route.query.filter},getOutMapType:function(){return this.attributes.route.query.map},getOutMapShowRecords:function(){return this.attributes.route.query.maprecords},getOutMapShowSources:function(){return this.attributes.route.query.mapsources},getOutColor:function(){return this.attributes.route.query.colorby},getOutSourceColor:function(){return this.attributes.route.query.sourcecolorby},getOutPlotColumns:function(){return this.attributes.route.query.plot},getOutTableSortColumn:function(){return this.attributes.route.query.sortcol},getOutTableSortOrder:function(){return this.attributes.route.query.sortorder},getOutSourceTableSortColumn:function(){return this.attributes.route.query.sourcesortcol},getOutSourceTableSortOrder:function(){return this.attributes.route.query.sourcesortorder},appConfigured:function(){return void 0!==this.attributes.config&&void 0!==this.attributes.labels},isComponentActive:function(t){var e={page:["#page"],db:["#out"]},r={"#record":"db"===this.getRoute()&&""!==this.getPath()&&!this.getPath().startsWith("s"),"#source":"db"===this.getRoute()&&""!==this.getPath()&&this.getPath().startsWith("s"),"#filters":"db"===this.getRoute()&&""===this.getPath()&&"s"!==this.getFilterType(),"#source-filters":"db"===this.getRoute()&&""===this.getPath()&&"s"===this.getFilterType()};return void 0!==e[this.getRoute()]&&e[this.getRoute()].indexOf(t)>=0||void 0!==r[t]&&r[t]},setRecordsUpdated:function(){return this.set("recordsUpdated",Date.now())},getRecordsUpdated:function(){return this.attributes.recordsUpdated},setSourcesUpdated:function(){return this.set("sourcesUpdated",Date.now())},getSourcesUpdated:function(){return this.attributes.sourcesUpdated},getRouteConfig:function(t){return void 0!==t?e.findWhere(this.attributes.config.routes,{id:t}):this.getActiveRouteConfig()},getActiveRouteConfig:function(){var t=this.getRoute();return e.contains(e.pluck(this.attributes.config.routes,"id"),t)?e.findWhere(this.attributes.config.routes,{id:t}):""},layersLoading:function(){return void 0===this.attributes.layerCollection||this.attributes.layerCollection.isLoading()},layerLoaded:function(t){return this.getLayers().get(t).isLoaded()},layersConfigLoaded:function(){return void 0!==this.attributes.layersConfig},layersConfigured:function(t){if(void 0===t)return this.attributes.layersConfigured;this.set("layersConfigured",t)},getLayersConfig:function(){return this.attributes.layersConfig},getLayers:function(){return this.attributes.layerCollection},setLayers:function(t){return this.set("layerCollection",t),this},getLayer:function(t){return this.getLayers().get(t)},setActiveLayersFromRoute:function(){return this.attributes.layerCollection.setActive(this.getActiveLayerIds()),this},setDefaultLayersFromRoute:function(){return this.attributes.layerCollection.setDefault(this.getLayerIdsByRoute(this.getActiveRouteConfig().id)),this},getActiveLayerIds:function(){var t=this.attributes.route.query;return void 0!==t.layers?t.layers:[]},getLayerIdsByRoute:function(r){var i=void 0!==r?this.getRouteConfig(r):this.getActiveRouteConfig(),o=[];return void 0===i.layers&&""!==i.layers||(o=t.isArray(i.layers)?i.layers:"string"==typeof i.layers?e.map(i.layers.split(","),function(t){return t.trim()}):[]),o},getOptionalLayerIdsByRoute:function(r){var i=void 0!==r?this.getRouteConfig(r):this.getActiveRouteConfig(),o=[];return void 0===i.layers_optional&&""!==i.layers_optional||(o=t.isArray(i.layers_optional)?i.layers_optional:"string"==typeof i.layers_optional?e.map(i.layers_optional.split(","),function(t){return t.trim()}):[]),o},getMapConfig:function(){return this.attributes.mapConfig},mapReady:function(){return this.appConfigured()&&this.layersConfigured()&&this.mapConfigured()&&!this.layersLoading()},mapConfigured:function(t){if(void 0===t)return this.attributes.mapConfigured;this.set("mapConfigured",t)},getActiveMapview:function(t){t=void 0!==t&&t;var e=void 0!==this.attributes.route.query.view?this.attributes.route.query.view:"default";return t?e:this.toMapviewObject(e)},toMapviewString:function(t){return t.center.lat+"|"+t.center.lng+"|"+t.zoom+"||"+t.dimensions[0]+"|"+t.dimensions[1]},toMapviewObject:function(t){if(void 0!==t){var e=t.split("||");if(2===e.length){var r=e[0].split("|"),i=e[1].split("|");return 3===r.length&&2===i.length?{center:{lat:parseFloat(r[0]),lng:parseFloat(r[1])},zoom:parseFloat(r[2]),dimensions:[parseFloat(i[0]),parseFloat(i[1])]}:null}return e=t.split("|"),4===e.length?{south:e[0],west:e[1],north:e[2],east:e[3]}:t}return null},getMapviewForRoute:function(t){t=void 0!==t&&t;var e,r=this.getActiveRouteConfig();switch(r.id){case"explore":e=r.view;break;default:e=this.getActiveMapview(!0)}return t?e:this.toMapviewObject(e)},getRecord:function(t){return this.attributes.recordCollection.get(t)},setRecords:function(t){this.set("recordCollection",t)},getRecords:function(){return this.attributes.recordCollection},getSelectedRecord:function(){return this.getRecord(this.getSelectedRecordId())},getSelectedRecordId:function(){return"db"===this.attributes.route.route&&""!==this.attributes.route.path&&this.attributes.route.path.startsWith("r")?this.attributes.route.path.replace("r",""):""},recordsConfigured:function(t){if(void 0===t)return this.attributes.recordsConfigured;this.set("recordsConfigured",t)},getSource:function(t){return this.attributes.sourceCollection.get(t)},setSources:function(t){this.set("sourceCollection",t)},getSources:function(){return this.attributes.sourceCollection},getSelectedSource:function(){return this.getSource(this.getSelectedSourceId())},getSelectedSourceId:function(){return"db"===this.attributes.route.route&&""!==this.attributes.route.path&&this.attributes.route.path.startsWith("s")?this.attributes.route.path.replace("s",""):""},sourcesConfigured:function(t){if(void 0===t)return this.attributes.sourcesConfigured;this.set("sourcesConfigured",t)},getReference:function(t){return this.attributes.referenceCollection.get(t)},setReferences:function(t){this.set("referenceCollection",t)},getReferences:function(){return this.attributes.referenceCollection},referencesConfigured:function(t){if(void 0===t)return this.attributes.referencesConfigured;this.set("referencesConfigured",t)},columnsConfigured:function(t){if(void 0===t)return this.attributes.columnsConfigured;this.set("columnsConfigured",t)},columnsInitialised:function(t){if(void 0===t)return this.attributes.columnsInitialised;this.set("columnsInitialised",t)},getOutColorColumn:function(){return this.attributes.columnCollection.get(this.getOutColor())},setColumns:function(t){this.set("columnCollection",t)},setColumnGroups:function(t){this.set("columnGroupCollection",t)},getColumns:function(){return this.attributes.columnCollection},getColumnGroups:function(){return this.attributes.columnGroupCollection},sourceColumnsConfigured:function(t){if(void 0===t)return this.attributes.sourceColumnsConfigured;this.set("sourceColumnsConfigured",t)},sourceColumnsInitialised:function(t){if(void 0===t)return this.attributes.sourceColumnsInitialised;this.set("sourceColumnsInitialised",t)},getOutSourceColorColumn:function(){return this.attributes.sourceColumnCollection.get(this.getOutSourceColor())},setSourceColumns:function(t){this.set("sourceColumnCollection",t)},setSourceColumnGroups:function(t){this.set("sourceColumnGroupCollection",t)},getSourceColumns:function(){return this.attributes.sourceColumnCollection},getSourceColumnGroups:function(){return this.attributes.sourceColumnGroupCollection},pagesConfigured:function(t){if(void 0===t)return this.attributes.pagesConfigured;this.set("pagesConfigured",t)},setPages:function(t){this.set("pages",t)},getPages:function(){return this.attributes.pages},getActivePage:function(){return"page"===this.getRoute()?this.attributes.pages.findWhere({id:this.getPath()}):null},getPageAnchor:function(){return void 0!==this.getQuery().anchor?this.getQuery().anchor:""}})});